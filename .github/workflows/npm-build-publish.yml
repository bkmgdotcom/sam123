name: Build NodeJS application

on:
  workflow_call:
    inputs:
      RUNS_ON:
        description: Platform to execute on
        type: string
        default: ubuntu-latest      
      JF_ARTIFACTORY_URL:
        description: JFrog Artifactory URL
        type: string
        default: https://your-jfrog-instance.jfrog.io/artifactory
        required: true  
      JF_PROJECT:
        description: JFrog Artifactory project
        type: string
        default: my-project
      JF_APP_NAME:
        description: JFrog Artifactory application name
        type: string
        default: my-app
      JF_NPM_LOCAL_REPOSITORY:
        description: Local npm repository
        type: string
        default: npm-local
      JF_NPM_REMOTE_REPOSITORY:
        description: Remote npm repository
        type: string
        default: npm-remote
      JF_PACKAGE_TAG:
        description: Remote npm repository
        type: string
        default: npm-remote
    secrets:
      JF_ACCESS_TOKEN:
        required: true

jobs:
  build:
    name: Build NodeJS app
    env:
      JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
      JF_ARTIFACTORY_URL: ${{ inputs.JF_ARTIFACTORY_URL }}
      JF_NPM_LOCAL_REPOSITORY: ${{ inputs.JF_NPM_LOCAL_REPOSITORY }}
      JF_NPM_REMOTE_REPOSITORY: ${{ inputs.JF_NPM_REMOTE_REPOSITORY }}
      JF_APP_NAME: ${{ inputs.JF_APP_NAME }}
      JF_PROJECT: ${{ inputs.JF_PROJECT }}
      JF_PACKAGE_TAG: ${{ inputs.JF_PACKAGE_TAG }}

    runs-on: ${{ inputs.RUNS_ON }}

    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Jfrog cli
        uses: jfrog/setup-jfrog-cli@v4
        env:
          JF_ARTIFACTORY_URL: ${{ env.JF_ARTIFACTORY_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
          JF_PROJECT: ${{ env.JF_PROJECT }}

      - name: Check environmental variables
        if: ${{ always() }}
        run: printenv | sort -f

      - name: JFrog NPM Configuration
        run: jf npm-config --server-id-resolve=default --server-id-deploy=default --repo-resolve=${{ env.JF_NPM_REMOTE_REPOSITORY }} --repo-deploy=${{ env.JF_NPM_LOCAL_REPOSITORY }}

      - name: Install NPM dependencies
        run: jf npm install --build-name ${{ env.JF_APP_NAME }} --build-number ${{ env.JF_PACKAGE_TAG }} 

      - name: Add environment variables
        run: jf rt bce --project ${{ env.JF_PROJECT }} ${{ env.JF_APP_NAME }} ${{ env.JF_PACKAGE_TAG }}

      - name: Add git information
        run: jf rt bag --project ${{ env.JF_PROJECT }} ${{ env.JF_APP_NAME }} ${{ env.JF_PACKAGE_TAG }}

      - name: Pack and publish the npm package
        run: |
          jf npm publish --project ${{ env.JF_PROJECT }} --build-name ${{ env.JF_APP_NAME }} --build-number ${{ env.JF_PACKAGE_TAG }}

      - name: Publish to Artifactory
        run: |
          jf rt bp --project ${{ env.JF_PROJECT }} ${{ env.JF_APP_NAME }} ${{ env.JF_PACKAGE_TAG }}
